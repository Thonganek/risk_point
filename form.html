<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แจ้งจุดเสี่ยงอุบัติเหตุ</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; padding-top: 60px; /* เว้นที่ให้ Navbar */ }
        
        /* Navbar Style */
        .navbar { z-index: 1030; height: 60px; }
        .btn-menu { border-width: 2px; font-weight: 500; }
        .btn-menu:hover { transform: translateY(-1px); }

        .header-bg { background-color: #198754; color: white; padding: 25px 0; margin-bottom: 20px; }
        
        /* Map Configuration */
        #map { 
            height: 50vh; 
            min-height: 400px;
            width: 100%; 
            border-radius: 8px; 
            border: 3px solid #198754; 
            margin-bottom: 20px; 
        }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
        <h4 class="mt-3 text-success">กำลังอัปโหลดและส่งข้อมูล...</h4>
        <p class="text-muted small">กรุณารอสักครู่...</p>
    </div>

    <!-- 1. Navbar (เพิ่มใหม่) -->
    <nav class="navbar navbar-dark bg-success fixed-top shadow-sm px-2">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <a class="navbar-brand d-flex align-items-center gap-2 me-0" href="map.html">
                <i class="fas fa-shield-alt fa-lg"></i>
                <span class="d-none d-sm-inline fw-bold">SafeRoad ร้อยเอ็ด</span>
            </a>
            <div class="d-flex gap-2">
                <a href="index.html" class="btn btn-outline-light btn-sm btn-menu">
                    <i class="fas fa-map-marked-alt"></i> <span class="d-none d-md-inline">แผนที่</span>
                </a>
                <a href="form.html" class="btn btn-light text-success btn-sm btn-menu fw-bold">
                    <i class="fas fa-exclamation-circle"></i> <span class="d-none d-md-inline">แจ้งจุดเสี่ยง</span>
                </a>
                <a href="admin.html" class="btn btn-outline-light btn-sm btn-menu">
                    <i class="fas fa-user-cog"></i> <span class="d-none d-md-inline">ผู้ดูแล</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="header-bg text-center shadow">
        <h3><i class="fas fa-exclamation-triangle"></i> แจ้งจุดเสี่ยงอุบัติเหตุ</h3>
        <p class="mb-0 small">ข้อมูลของท่านจะช่วยให้เจ้าหน้าที่เข้าแก้ไขพื้นที่ได้รวดเร็วขึ้น</p>
    </div>

    <div class="container-fluid px-md-5 pb-5">
        <div class="row justify-content-center">
            <div class="col-xl-10">
                
                <!-- Step 1: Map -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-success"><i class="fas fa-map-marked-alt"></i> 1. ระบุตำแหน่ง (แตะบนแผนที่)</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="getCurrentLocation()">
                            <i class="fas fa-crosshairs"></i> หาตำแหน่งฉัน
                        </button>
                    </div>
                    <div class="card-body p-2">
                        <div id="map"></div>
                        <div class="alert alert-warning py-2 mb-0 mt-2 small text-center">
                            <i class="fas fa-map-marker-alt"></i> พิกัดที่เลือก: 
                            <span id="latDisplay" class="fw-bold">-</span>, <span id="lngDisplay" class="fw-bold">-</span>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Form -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-edit"></i> 2. รายละเอียดจุดเสี่ยง</h5>
                    </div>
                    <div class="card-body">
                        <form id="reportForm">
                            <input type="hidden" id="lat" name="lat" required>
                            <input type="hidden" id="lng" name="lng" required>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">ประเภทความเสี่ยง <span class="text-danger">*</span></label>
                                    <select class="form-select" id="type" required>
                                        <option value="" selected disabled>-- กรุณาเลือก --</option>
                                        <option value="ไม่มีไฟส่องสว่าง">ไม่มีไฟส่องสว่าง</option>
                                        <option value="โค้งอันตราย">โค้งอันตราย</option>
                                        <option value="จุดตัด/แยกอันตราย">จุดตัด/แยกอันตราย</option>
                                        <option value="ถนนชำรุด/เป็นหลุมบ่อ">ถนนชำรุด/เป็นหลุมบ่อ</option>
                                        <option value="น้ำท่วมขังบ่อย">น้ำท่วมขังบ่อย</option>
                                        <option value="รถใช้ความเร็วสูงบ่อย">รถใช้ความเร็วสูงบ่อย</option>
                                        <option value="ใกล้สถานศึกษา/ชุมชน">ใกล้สถานศึกษา/ชุมชน</option>
                                        <option value="ทางม้าลายไม่ชัดเจน">ทางม้าลายไม่ชัดเจน</option>
                                        <option value="อื่น ๆ">อื่น ๆ (ระบุ)</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold">ถ่ายภาพพื้นที่ (สูงสุด 5 รูป)</label>
                                    <input type="file" class="form-control" id="imageFiles" accept="image/*" multiple>
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-bold">รายละเอียดเพิ่มเติม <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="detail" rows="3" placeholder="อธิบายลักษณะพื้นที่ หรือจุดสังเกต..." required></textarea>
                                </div>
                            </div>

                            <hr class="my-4">
                            
                            <h6 class="text-muted mb-3">ข้อมูลผู้แจ้ง (ไม่บังคับ)</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="name" placeholder="ชื่อ-นามสกุล">
                                </div>
                                <div class="col-md-6">
                                    <input type="tel" class="form-control" id="phone" placeholder="เบอร์โทรศัพท์">
                                </div>
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-success btn-lg shadow">
                                    <i class="fas fa-paper-plane"></i> ส่งข้อมูลแจ้งจุดเสี่ยง
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://script.google.com/macros/s/AKfycbzijdD1QU4JU0Q4KZV9UZbDNgruBuGpCatWbASNdLcJiaetI_otDeIMdBgV10-8rrQR/exec';
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA1xmTQ_hd4n-FPyqIiUqPhAElgMRdYfUo&callback=initMap" async defer></script>

    <script>
        let map, marker;

        function initMap() {
            const roiEtPos = { lat: 16.0538, lng: 103.6520 }; 

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: roiEtPos,
                mapTypeId: google.maps.MapTypeId.SATELLITE,
                streetViewControl: false,
                mapTypeControl: true,
                fullscreenControl: true
            });

            map.addListener("click", (e) => {
                placeMarker(e.latLng);
            });

            // ตรวจสอบ URL Params เพื่อดูว่าส่งพิกัดมาหรือไม่
            checkUrlParams();
        }

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get('lat'));
            const lng = parseFloat(urlParams.get('lng'));

            if (!isNaN(lat) && !isNaN(lng)) {
                // ถ้ามีพิกัดส่งมา ให้ปักหมุดเลย
                const pos = { lat: lat, lng: lng };
                map.setCenter(pos);
                placeMarker(pos);
            } else {
                // ถ้าไม่มี ให้ลองหาพิกัดปัจจุบัน
                getCurrentLocation();
            }
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const currentPos = { lat: position.coords.latitude, lng: position.coords.longitude };
                        map.setCenter(currentPos);
                        if (!marker) placeMarker(currentPos); // ปักหมุดถ้ายังไม่มีหมุด (เช่นไม่ได้มาจากลิงก์)
                    },
                    (error) => console.warn("Geolocation error")
                );
            }
        }

        function placeMarker(location) {
            if (marker) marker.setMap(null);
            
            marker = new google.maps.Marker({
                position: location,
                map: map,
                animation: google.maps.Animation.DROP,
                draggable: true 
            });

            updateCoordinates(location);

            marker.addListener('dragend', function(e) {
                updateCoordinates(e.latLng);
            });
        }

        function updateCoordinates(latLng) {
            let lat = typeof latLng.lat === 'function' ? latLng.lat() : latLng.lat;
            let lng = typeof latLng.lng === 'function' ? latLng.lng() : latLng.lng;
            
            document.getElementById("lat").value = lat.toFixed(6);
            document.getElementById("lng").value = lng.toFixed(6);
            document.getElementById("latDisplay").innerText = lat.toFixed(6);
            document.getElementById("lngDisplay").innerText = lng.toFixed(6);
        }

        document.getElementById("reportForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            if (!document.getElementById("lat").value) {
                Swal.fire('แจ้งเตือน', 'กรุณาแตะบนแผนที่เพื่อระบุตำแหน่งจุดเสี่ยง', 'warning');
                return;
            }

            const fileInput = document.getElementById("imageFiles");
            if (fileInput.files.length > 5) {
                Swal.fire('แจ้งเตือน', 'สามารถแนบรูปได้สูงสุด 5 รูปเท่านั้น', 'warning');
                return;
            }

            document.getElementById("loading").style.display = "flex";

            const formData = {
                lat: document.getElementById("lat").value,
                lng: document.getElementById("lng").value,
                type: document.getElementById("type").value,
                detail: document.getElementById("detail").value,
                name: document.getElementById("name").value,
                phone: document.getElementById("phone").value,
                imagesBase64: [] 
            };

            if (fileInput.files.length > 0) {
                try {
                    const promises = Array.from(fileInput.files).map(file => convertToBase64(file));
                    formData.imagesBase64 = await Promise.all(promises);
                } catch (err) {
                    Swal.fire('Error', 'เกิดข้อผิดพลาดในการอ่านไฟล์รูปภาพ', 'error');
                    document.getElementById("loading").style.display = "none";
                    return;
                }
            }

            try {
                const response = await fetch(BASE_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'saveReport', data: formData })
                });
                const result = await response.json();

                document.getElementById("loading").style.display = "none";

                if (result.status === 'success') {
                    Swal.fire({
                        title: 'บันทึกสำเร็จ!',
                        text: 'ขอบคุณที่ร่วมแจ้งจุดเสี่ยงอุบัติเหตุ',
                        icon: 'success',
                        confirmButtonText: 'กลับไปหน้าแผนที่'
                    }).then(() => {
                        window.location.href = 'map.html'; // ส่งกลับหน้าแผนที่
                    });
                } else {
                    Swal.fire('เกิดข้อผิดพลาด', result.message, 'error');
                }

            } catch (error) {
                document.getElementById("loading").style.display = "none";
                Swal.fire('Error', 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้', 'error');
            }
        });

        const convertToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };
    </script>
</body>

</html>
